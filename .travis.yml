language: scala
scala: 2.12.6
jdk: oraclejdk8

stages:
  - name: test
  - name: publish
    if: NOT type = pull_request

cache:
  directories:
    - $HOME/.ivy2/cache
    - $HOME/.sbt
    - $HOME/.coursier/cache
    - '.hoarder-cache'

env:
  global:
    - COURSIER_PROGRESS=0
    - SBT=./sbt
    # ENCRYPTION_PASSWORD
    - secure: "jFmgFgsZIudE/f/f7DFnUCdyJ3h9T1SvCfK1iTsG9uT+ZeJJZLVHiyOxLi5F9UXcZ9A2iW6f5dHhOeZOh5UugEUy5AR3f6dac6G9WLoglDBClnf19aNQ6mBEWpopOUEpivUgmC/8iWAWRQYkqj+kPCr2DxnF+M32MLarr7ylcQrRRlE8fSrqg3llqH6sIiQdQnpZjh9/9tmnltrQfXTewwgFvgpA7iWOH7oy4qmYWHsl1Yz8dHzmCXQhnPFjiyAFk7X8QrfZFDxG+25cdpRhLh2ilgCJz1IVqbTXfmmUOsyib25NaL3Xs+43KyLR6dwjCxukSlTNcAi31y44ttiBon9hqHSSddzwoVW4/i7R0qHrA/c2a/9Ulvxvd1Z7kPf63glqTAWht4g41nTAit9guO+LkJbDlM1BARzllzbczUZF+FP5TmS0QEp9bor6LHOzsT0rR+5d/NUFB1pZRU22YaFwdCeyfTR0qAOQK92D2p4DMjJ8TzxzxycKN/cRwDR4VXj12riobYW2K+qczZEZ9N9EQy6HrrdmyPJQHaYC6t5QMbjqLqQIAdV+EKdHpzqm/8bOqdmd32ZlykLxLAYpCDzGmLzYsf6+dGUQ7Q51aHl//BGPrvg2y5PoGwkSpxkyh4IxSuSNcNmC3lueFag8YsyMy1ZRZw43RHI0kIX7LbQ="
    # GITHUB_TOKEN
    - secure: "GJrmL+0FD0EXJ5P3KxnYK6x+C6zyxKkNg864A0tBkEg3Nw36vccWNCOk0Pl82LHndTw9tSfgsrlqvsaWVgABSmyOFfWsePsayxrsBB2+8IH9rwt5vZrk7pNaNK4TM6NZObRvnYRCEImEJup1ztLRt9hxTVBsbYwm7FwLXkkD7AqLOnvHt0x2YsYbZO2nPBVRlR6t8Ru9c1hIuibJ1SrSSIIMWQZXjm+pB2ez5w4vMYZvAAnEyVnxuJNyVz6XtMlwcdY9KEi4m+KjVMdQ0t6oYU+Ib9ZVgE7bylE7nTL5SkA9spqXDW2j+hgx3AiDRvfOzGcDpViRPDkd/FMx/kGbXh1JzD18DafcF15QG3uAbul1Mer8geth2CbQGDr53+727P9zHewx9H19/U+mWQjBqNxdPX9ClLQoPAFiYoXXAUgYIG/VxJebFuGyXoSXmXEf3IqwSpky9bNFgM3YD16D7rDtI4DGa/MgVFIHHwM0UdhuNwf9cDBio0MGo0kwcykg/N4hb6ATp8J4gMBYWtmWDsySG0djoPfGQpj4iD14cg74dsDL9DCqMDTEdTy9Vq7UwNvu/OqU+jlIUCGZ1aORcdb3VRHEW5oPlW+is0FfUdK0EkorU+JQ31vf5wjAuYIdlg2AVI2rbtB/kTJk9wt4OT0fd69LwOPZQcZucrOHKto="
    # GITHUB_ACCESS_TOKEN
    - secure: "a3c9jrnnhTrm8RM9daYKhOWblXMcFNYn6LsNPTU9M15Ti46hFGY6cJ3r750VFYvXdzjxjq+7PY66q+iaLoMR0n41rIwPq5rdfcL14Sp/ZdgVQ/AXqNjpX1aaffR3U2WT+EGzvN/lyFy1k4C0qehTt9CvcEVNsHHQl07XfpWcVpCRp1J6fyfXSJbwRjh/gjO8WRhw0U5nSgk24Exliikc+0SLgdIqi3rLlFVxJaMIlPdUZKgCLVZ43r8NZk7ikXI9a8we/6OFBa/ufIkZ0S7TNEKuB0ZZ/RUgNbrCTQHiFXuRBtLSMHjUUXcsQUF7dnymKi7ea59ViZoUEVwGv6x1c8YMrgtr63FoN/T9Qo4SpBBVx2Exko7y+oQ2Hd7lwhFxp9ftcllQrLUDCM/OfCNRXNo1id4xg4OJh5dq9x5rKirbbTliUDgr0QXiO/yqgAJLLQ7hYQKJBavq7SdqU4guzAuxKm/8K86sVTcUQBstCdM/XOeSWrZY/8VQZsldPiVF/k114XRnUSigVQlNxcSuaxff3zn5QwMvnNPpFiUwKodBmw52wufD5j1F+9OWJx61JwKamuTgj8zjtBJlQ0eL9y09q+0J3kcDvAGtPeM0ZZfE+FPMq1yzwgRJI3gOo0QK2bBRljq/xSNSt78Km2kMkyOTAlQhd/zpK7QCpMg1lEU="
    # DISCORD_WEBHOOK_TOKENS
    - secure: "NIzEvcqJ+2JiyVGDbmoqDZwUVPeT1Tf0gSTpmELyOgZEv3AgIzXCeAGGZxymHu9KQ8gsjDZI2KOnfjf82dfgE5I7bjxGIu4bZyVZToJOaNeqU9tt62JAqmZMH9FepD7+P09FQAkSBTV3s0qHh6pL2lboPbIji07nYognHsRI8+7afKJtjux1rte+DHfgw3RiMAp/pwyv5U6L6/yjCmV4t94+Uif2ZnFKj6l+fmk3KoMdIFm5BCns9QxVImoXcqH88t4Zn56sAcHDqRShpGlgzDY4TrvZP3iPr2EQCY4JdMBbNfZz0sOJk8PIJIDS4mxRzZRLXfBN2PahxLT5YXIarAcqIKCTyRoywXSIWn1fQKr5Q7duJdQwZHwERiYzvurMazY5NcUkoSzPBornJh41UkvUlEX2aosk63bqr4vjzEQbXMgHdhh++nwMosmdo2e8d0m7R8OGEDrKFNyjj5YA3qnyOHFGR294airIMXeJZnecVRHaTUBSt95XnmsVelkbgd2Y+S1uduOtMGQ2WAa1TjdRXUOPcNj8Va/ar2LtBg1yG027nbImbmSLlAwveUZae+hUx/UO9KEifjlc64vE/j9XG42MS4vM6+KZt5L2fd6QXDDV+YN4B3nslqzFXeIvYA7EnP6M24t5NSQMUOppW6RX1cn0Q20MuwC/hBEodvk="

jobs:
  include:
    - stage: test
      script:
        - set -e
        - $SBT ++$TRAVIS_SCALA_VERSION test

    - stage: publish
      env:
      script:
        - set -e
        - $SBT transferPublishAndTagResources
        - TRAVIS_JOB_NUMBER=1 scripts/publishAndTag 'slamdata/qdata'

      git:
        depth: false

after_success:
  - scripts/discordTravisPost success https://discordapp.com/api/webhooks/$DISCORD_WEBHOOK_TOKENS

after_failure:
  - scripts/discordTravisPost failure https://discordapp.com/api/webhooks/$DISCORD_WEBHOOK_TOKENS

branches:
  only:
    - master
    - /^backport.*$/

before_cache:
  - find "$HOME/.sbt/" -name '*.lock' -print0 | xargs -0 rm
  - find "$HOME/.ivy2/" -name 'ivydata-*.properties' -print0 | xargs -0 rm
